---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { getArticleStructuredData } from "../../lib/structuredData";

type Post = CollectionEntry<"posts">;

export async function getStaticPaths() {
  const posts = (await getCollection("posts")) as Post[];

  return posts
    .filter((p: Post) => !p.data.draft)
    .map((p: Post) => ({
      params: { slug: p.slug },
      props: { post: p },
    }));
}

const { post } = Astro.props as { post: Post };
const { Content } = await post.render();

const title = `${post.data.title} | Sayyidi Shaarani`;
const description = post.data.description;
const primaryLabel = post.data.primaryLabel;

// Related notes: prioritize same taxonomy label, then fill from the rest.
const all = (await getCollection("posts")) as Post[];
const published = all.filter((p: Post) => !p.data.draft && p.slug !== post.slug);

const sameLabel = published
  .filter((p: Post) => p.data.primaryLabel === primaryLabel)
  .sort((a: Post, b: Post) => a.data.title.localeCompare(b.data.title));

const otherNotes = published
  .filter((p: Post) => p.data.primaryLabel !== primaryLabel)
  .sort((a: Post, b: Post) => a.data.title.localeCompare(b.data.title));

const related = [...sameLabel, ...otherNotes].slice(0, 3);
const structuredData = getArticleStructuredData({
  path: `/notes/${post.slug}/`,
  title: post.data.title,
  description: post.data.description,
  datePublished: post.data.date,
  primaryLabel: post.data.primaryLabel,
  secondaryLabel: post.data.secondaryLabel,
});
---

<BaseLayout
  title={title}
  description={description}
  canonicalPath={`/notes/${post.slug}/`}
  ogType="article"
  structuredData={structuredData}
>
  <article class="note" aria-labelledby="note-title">
    <p class="muted backLink">
      <a href="/notes/">← Notes</a>
    </p>

    <header class="noteHeader">
      <h1 id="note-title">{post.data.title}</h1>

      {post.data.series && (
        <p class="seriesLine">
          {post.data.series}
        </p>
      )}

      <p class="muted labelLine">Label: {primaryLabel}</p>

      {post.data.description && (
        <p class="muted summary">
          {post.data.description}
        </p>
      )}

      <div class="divider"></div>
    </header>

    <Content />

    <div class="divider"></div>

    <p class="muted postNav">
      <a href="/inspection/">How Inspection Works</a> · <a href="/notes/">All Notes</a>
    </p>

    {related.length > 0 && (
      <section class="moreNotes" aria-labelledby="related-notes-title">
        <h2 id="related-notes-title">Related Notes</h2>
        <ul>
          {related.map((p: Post) => (
            <li>
              <a href={`/notes/${p.slug}/`}>{p.data.title}</a>
            </li>
          ))}
        </ul>
      </section>
    )}
  </article>
</BaseLayout>

<style>
  .note {
    margin-top: 0;
    max-width: 66ch;
  }

  .backLink {
    margin-bottom: 1.25rem;
  }

  .backLink a {
    text-decoration: none;
  }

  .backLink a:hover {
    text-decoration: underline;
  }

  .seriesLine {
    margin-top: 0.6rem;
    margin-bottom: 0;
    font-size: 0.9rem;
    color: var(--text);
  }

  .labelLine {
    margin: 0.3rem 0 0.75rem;
    font-size: 0.85rem;
  }

  .summary {
    margin: 0 0 1.5rem;
    max-width: 62ch;
  }

  .note :global(hr) {
    margin: var(--space-4) 0;
  }

  .note :global(h2) {
    margin-top: var(--space-3);
  }

  .note :global(p),
  .note :global(li) {
    line-height: 1.74;
  }

  .note :global(ul),
  .note :global(ol) {
    margin-bottom: var(--space-3);
  }

  .divider {
    border-top: 1px solid var(--border);
    margin: var(--space-3) 0;
  }

  .postNav {
    margin-bottom: 0;
  }

  .moreNotes {
    margin-top: var(--space-4);
  }

  .moreNotes h2 {
    font-size: 1.02rem;
    margin-bottom: 0.75rem;
  }
</style>
